/* ==================
 脚本类型: 脚本
 版权：游戏盒团队     
 联系扣扣：297870163    609654666
 =====================
 */var exitMap=0,waitingMap=1,reviveMap=2,winnerMap=3,loserMap=4,bossMap=5,redFirstMap=6,blueFirstMap=11;function init(){}function monsterValue(a,b){return 1}function setup(a){var b=100*(parseInt(a)+1);a=em.newInstance("Ghost"+a);a.setInstanceMap(923020001);a.setInstanceMap(b+92302E4);a.setInstanceMap(b+923020009);a.setInstanceMap(923020010);a.setInstanceMap(923020020);a.setInstanceMap(b+923020090).resetFully();for(var c=0;5>c;c++)a.setInstanceMap(923020010+b+c).resetFully();for(c=0;5>c;c++)a.setInstanceMap(923020020+b+c).resetFully();a.setProperty("forfeit","false");a.setProperty("blue","-1");a.setProperty("red","-1");a.setProperty("started","false");a.setProperty("boss","false");a.setProperty("finished","false");a.setProperty("Red_Stage","1");a.setProperty("Blue_Stage","1");a.setProperty("redTeamDamage","0");a.setProperty("blueTeamDamage","0");return a}function broadcastUpdate(a,b,c){b.writePoint("PRaid_Point",a.getProperty(b.getId()+"-Ghost_Point"));if(!c)if(a.getProperty("boss").equals("false"))b.writeEnergy("PRaid_Team",0==b.getCarnivalParty().getTeam()?"redTeam":"blueTeam"),b.writeStatus("Red_Stage",a.getProperty("Red_Stage")),b.writeStatus("Blue_Stage",a.getProperty("Blue_Stage"));else if(a.getProperty("finished").equals("false"))b.writeStatus("Red_Stage","B"),b.writeStatus("Blue_Stage","B"),b.writeStatus("redTeamDamage",a.getProperty("redTeamDamage")),b.writeStatus("blueTeamDamage",a.getProperty("blueTeamDamage"));else{b.writeStatus("Red_Stage","BC");b.writeStatus("Blue_Stage","BC");c=a.getProperty(b.getId()+"-Ghost_Point");var d=a.getProperty(b.getId()+"-PRaid_Bonus");b.writeEnergy("PRaid_Point",20*parseInt(c));b.writeEnergy("PRaid_Bonus",d);a.setProperty(b.getId()+"-PRaid_Total",20*parseInt(c)+parseInt(d)+"");b.writeEnergy("PRaid_Total",a.getProperty(b.getId()+"-PRaid_Total"));b.writeEnergy("PRaid_Team","")}}function playerEntry(a,b){b.disposeClones();b.changeMap(a.getMapInstance(waitingMap),a.getMapInstance(waitingMap).getPortal(0));a.setProperty(b.getId()+"-Ghost_Point","0");a.setProperty(b.getId()+"-PRaid_Bonus","0");a.setProperty(b.getId()+"-PRaid_Total","0")}function registerCarnivalParty(a,b){a.getProperty("red").equals("-1")?(a.setProperty("red",b.getLeader().getId()+""),a.schedule("end",18E4)):(a.setProperty("blue",b.getLeader().getId()+""),a.schedule("start",1E4))}function playerDead(a,b){}function leftParty(a,b){disbandParty(a)}function disbandParty(a){disposeAll(a)}function disposeAll(a){for(var b=a.getPlayers().iterator();b.hasNext();){var c=b.next();a.unregisterPlayer(c);c.changeMap(a.getMapInstance(exitMap),a.getMapInstance(exitMap).getPortal(0));null!=c.getCarnivalParty()&&c.getCarnivalParty().removeMember(c)}a.dispose()}function playerExit(a,b){a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);b.changeMap(a.getMapInstance(exitMap),a.getMapInstance(exitMap).getPortal(0));a.disposeIfPlayerBelow(0,0)}function removePlayer(a,b){a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);b.getMap().removePlayer(b);b.setMap(a.getMapInstance(exitMap));a.disposeIfPlayerBelow(0,0)}function getParty(a,b){var c=em.getChannelServer().getPlayerStorage().getCharacterById(parseInt(a.getProperty(b)));return null==c||null==c.getCarnivalParty()?(a.broadcastPlayerMsg(5,"\u7ec4\u961f\u961f\u957f"+b+"\u6ca1\u627e\u5230."),disposeAll(a),null):c.getCarnivalParty()}function start(a){a.setProperty("started","true");a.startEventTimer(18E5);var b=getParty(a,"blue"),c=getParty(a,"red");null!=b&&null!=c&&(b.warp(a.getMapInstance(blueFirstMap),1),c.warp(a.getMapInstance(redFirstMap),1))}function monsterKilled(a,b,c){for(var d=a.getPlayers().iterator();d.hasNext();){var e=d.next();e.getCarnivalParty().getTeam()==b.getCarnivalParty().getTeam()&&(a.setProperty(e.getId()+"-Ghost_Point",parseInt(a.getProperty(e.getId()+"-Ghost_Point"))+c+""),broadcastUpdate(a,e,!0))}}function monsterValue(a,b){return 0}function monsterDamaged(a,b,c,d){if(9700037==c){c=parseInt(a.getProperty("blueTeamDamage"));var e=parseInt(a.getProperty("redTeamDamage"));0==b.getCarnivalParty().getTeam()?a.setProperty("redTeamDamage",e+d+""):a.setProperty("blueTeamDamage",c+d+"");a.setProperty(b.getId()+"-PRaid_Bonus",parseInt(a.getProperty(b.getId()+"-PRaid_Bonus"))+d/100);for(d=a.getPlayers().iterator();d.hasNext();)broadcastUpdate(a,d.next(),!1);if(2E6<=c&&1==b.getCarnivalParty().getTeam()||2E6<=e&&0==b.getCarnivalParty().getTeam()){a.setProperty("finished","true");b=getParty(a,"blue");var f=getParty(a,"red");c>e?b.setWinner(!0):e>c&&f.setWinner(!0);for(d=a.getPlayers().iterator();d.hasNext();)d.next().endPartyQuest(1303);b.displayMatchResult();f.displayMatchResult();a.schedule("warpOut",1E4)}}return 0}function end(a){a.getProperty("started").equals("true")||disposeAll(a)}function warpOut(a){if(a.getProperty("started").equals("true")){var b=getParty(a,"blue"),c=getParty(a,"red");null!=b&&null!=c&&(b.isWinner()?(b.warp(a.getMapInstance(winnerMap),0),c.warp(a.getMapInstance(loserMap),0)):(c.warp(a.getMapInstance(winnerMap),0),b.warp(a.getMapInstance(loserMap),0)),a.disposeIfPlayerBelow(100,0))}else a.getProperty("blue").equals("-1")&&disposeAll(a)}function scheduledTimeout(a){a.stopEventTimer();if(a.getProperty("started").equals("true")){var b=parseInt(a.getProperty("blueTeamDamage")),c=parseInt(a.getProperty("redTeamDamage"));a.setProperty("finished","true");var d=getParty(a,"blue"),e=getParty(a,"red");a.getProperty("boss").equals("false")&&(b=parseInt(a.getProperty("Blue_Stage")),c=parseInt(a.getProperty("Red_Stage")));b>c?d.setWinner(!0):c>b&&e.setWinner(!0);d.displayMatchResult();e.displayMatchResult();a.schedule("warpOut",1E4)}else a.getProperty("blue").equals("-1")&&disposeAll(a)}function playerRevive(a,b){b.addHP(50);b.changeMap(a.getMapInstance(reviveMap),a.getMapInstance(reviveMap).getPortal(0));return!0}function playerDisconnected(a,b){b.setMap(a.getMapInstance(exitMap));a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);a.broadcastPlayerMsg(5,b.getName()+" \u5df2\u9000\u51fa\u7ec4\u961f\u4efb\u52a1.");disposeAll(a)}function onMapLoad(a,b){if(b.getMapId()==a.getMapInstance(exitMap).getId())playerExit(a,b);else if(a.getProperty("started").equals("true"))if(a.getProperty("boss").equals("false")){if(0==b.getCarnivalParty().getTeam())if(b.getMapId()==a.getMapInstance(redFirstMap).getId())b.tryPartyQuest(1303);else if(b.getMapId()==a.getMapInstance(redFirstMap+1).getId())a.setProperty("Red_Stage","2");else if(b.getMapId()==a.getMapInstance(redFirstMap+2).getId())a.setProperty("Red_Stage","3");else if(b.getMapId()==a.getMapInstance(redFirstMap+3).getId())a.setProperty("Red_Stage","4");else if(b.getMapId()==a.getMapInstance(redFirstMap+4).getId())a.setProperty("Red_Stage","5");else{if(b.getMapId()==a.getMapInstance(bossMap).getId()){a.setProperty("Red_Stage","B");a.setProperty("Blue_Stage","B");a.setProperty("boss","true");a.setProperty("redTeamDamage","100000");a.broadcastPlayerMsg(6,"\u7ea2\u961f\u5df2\u7ecf\u5230\u8fbeBOSS\u5730\u56fe\uff0c\u5c06\u83b7\u5f975\uff05\u7684\u63d0\u5347.");for(var c=a.getPlayers().iterator();c.hasNext();){var d=c.next();d.changeMap(b.getMap(),b.getMap().getPortal(0==d.getCarnivalParty().getTeam()?"redTeam":"blueTeam"))}}}else if(b.getMapId()==a.getMapInstance(blueFirstMap).getId())b.tryPartyQuest(1303);else if(b.getMapId()==a.getMapInstance(blueFirstMap+1).getId())a.setProperty("Blue_Stage","2");else if(b.getMapId()==a.getMapInstance(blueFirstMap+2).getId())a.setProperty("Blue_Stage","3");else if(b.getMapId()==a.getMapInstance(blueFirstMap+3).getId())a.setProperty("Blue_Stage","4");else if(b.getMapId()==a.getMapInstance(blueFirstMap+4).getId())a.setProperty("Blue_Stage","5");else if(b.getMapId()==a.getMapInstance(bossMap).getId())for(a.setProperty("Blue_Stage","B"),a.setProperty("Red_Stage","B"),a.setProperty("boss","true"),a.setProperty("blueTeamDamage","100000"),a.broadcastPlayerMsg(6,"\u84dd\u961f\u5df2\u7ecf\u5230\u8fbeBOSS\u5730\u56fe\uff0c\u5c06\u83b7\u5f975\uff05\u7684\u63d0\u5347."),c=a.getPlayers().iterator();c.hasNext();)d=c.next(),d.changeMap(b.getMap(),b.getMap().getPortal(0==d.getCarnivalParty().getTeam()?"redTeam":"blueTeam"));for(c=a.getPlayers().iterator();c.hasNext();)broadcastUpdate(a,c.next(),!1)}else a.getProperty("finished").equals("false")||(broadcastUpdate(a,b,!1),b.gainExp(parseInt(a.getProperty(b.getId()+"-PRaid_Total"))*em.getChannelServer().getExpRate(),!0,!0,!1));else disposeAll(a)}function cancelSchedule(){}function clearPQ(a){}function allMonstersDead(a){}function changedMap(a,b,c){};