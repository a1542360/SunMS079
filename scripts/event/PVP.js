/* ==================
 脚本类型: 脚本
 版权：游戏盒团队     
 联系扣扣：297870163    609654666
 =====================
 */importPackage(Packages.tools.packet);function init(){}function setup(a){var b=em.newInstance("PVP"+a.replace(" ","").replace(" ",""));b.setProperty("lvl",a.split(" ")[0]);b.setProperty("type",a.split(" ")[1]);a=parseInt(a.split(" ")[2]);b.setProperty("map",""+a);b.setProperty("started","0");b.setProperty("champion","0");b.setProperty("ice","0");b.setProperty("icegage","0");b.setProperty("red","0");b.setProperty("blue","0");b.setProperty("redflag","0");b.setProperty("blueflag","0");b.createInstanceMap(a).resetFully();return b}function playerEntry(a,b){var c=parseInt(a.getProperty("type")),d=a.getMapInstance(0);b.changeTeam(2==c||d.getAndSwitchTeam()?0:1);b.changeMap(d,d.getPortal(0==c?0:3==c?0==b.getTeam()?3:1:0==b.getTeam()?2:3));a.setProperty(""+b.getId(),"0");a.broadcastPlayerMsg(-7,b.getName()+" has entered.");b.getStat().recalcLocalStats(b);b.getStat().heal(b);var e=getMaxPlayerCount(c);broadcastType(a,b);a.getProperty("started").equals("0")?(a.broadcastPacket(WvsContext.getMidMsg("Current: "+a.getPlayerCount()+"/ Needed to Start: "+e,!0,1)),a.broadcastPacket(WvsContext.getMidMsg("Currently recruiting players for Battle Mode.",!0,0)),a.getPlayerCount()>=(b.isGM()?2:e)&&(a.broadcastPacket(WvsContext.clearMidMsg()),a.broadcastPacket(CPacket.getPVPScore(0,!1)),a.broadcastPacket(CPacket.getPVPMode(c)),a.broadcastPacket(CPacket.enablePVP(!0)),a.setProperty("started","1"),doItemDrop(a),a.startEventTimer(2==c?42E4:6E5),a.schedule("championCheck",3E5),2==c?(c=a.getPlayers(),c=c.get(java.lang.Math.floor(java.lang.Math.random()*c.size())),a.setProperty("ice",c.getId()+""),c.changeTeam(1),a.applySkill(c,c.getStat().getSkillByJob(1105,c.getJob())),c.getStat().recalcLocalStats(c),c.getStat().heal(c)):3==c&&(d.spawnAutoDrop(291E4,d.getGuardians().get(0).left),d.spawnAutoDrop(2910001,d.getGuardians().get(1).left),a.broadcastPacket(CPacket.getCapturePosition(d)),a.broadcastPacket(CPacket.resetCapture())),updateScoreboard(a,!0))):(0!=c&&b.getClient().getSession().write(CPacket.getPVPPoints(parseInt(a.getProperty("red")),parseInt(a.getProperty("blue")))),b.getClient().getSession().write(CPacket.getPVPScore(0,!1)))}function broadcastType(a){for(var b=parseInt(a.getProperty("type")),c=parseInt(a.getProperty("lvl")),d=a.getPlayers(),e=a.newPair(),g=a.newPair(),f=0;f<d.size();f++)a.addToPair(0==d.get(f).getTeam()?e:g,d.get(f).getId(),d.get(f).getName());a.broadcastTeamPacket(CPacket.getPVPType(b,e,1,!a.getProperty("started").equals("0"),c),0);a.broadcastTeamPacket(CPacket.getPVPTeam(e),0);a.broadcastTeamPacket(CPacket.getPVPType(b,g,2,!a.getProperty("started").equals("0"),c),1);a.broadcastTeamPacket(CPacket.getPVPTeam(g),1)}function broadcastType(a,b){if(null==b)broadcastType(a);else{for(var c=parseInt(a.getProperty("type")),d=parseInt(a.getProperty("lvl")),e=a.getPlayers(),g=a.newPair(),f=a.newPair(),k=0;k<e.size();k++)a.addToPair(0==e.get(k).getTeam()?g:f,e.get(k).getId(),e.get(k).getName());a.broadcastTeamPacket(CPacket.getPVPType(c,0==b.getTeam()?g:f,b.getTeam()+1,!a.getProperty("started").equals("0"),d),b.getTeam());a.broadcastTeamPacket(CPacket.getPVPTeam(0==b.getTeam()?g:f),b.getTeam())}}function getMaxPlayerCount(a){switch(a){case 0:return 4;case 1:case 3:return 6;case 2:return 10}return 0}function doItemDrop(a){for(var b=a.getMapInstance(0),c=b.getFootholds().getAllRelevants(),d=java.lang.Math.floor(10*java.lang.Math.random())+5,e=0;e<d;e++){var g=java.lang.Math.floor(50*java.lang.Math.random())+29E5;2900049!=g&&2900043!=g&&2900042!=g&&2900039!=g&&2900038!=g&&2900037!=g&&2900029!=g&&2900016!=g&&2900015!=g&&b.spawnAutoDrop(g,new java.awt.Point(c.get(java.lang.Math.floor(java.lang.Math.random()*c.size())).getPoint1()))}a.schedule("doItemDrop",6E4)}function addPVPScore(a,b,c){var d=parseInt(a.getProperty(""+b.getId()));a.setProperty(""+b.getId(),""+(d+c));if(parseInt(a.getProperty("ice"))==b.getId()){var e=java.lang.Math.min(100,parseInt(a.getProperty("icegage"))+d);a.setProperty("icegage",""+e);b.getClient().getSession().write(CPacket.getPVPIceGage(e));b.applyIceGage(e)}a=((d+c)/10|0)-(d/10|0);0<a&&b.gainExp(a*calcFluctuation(d+c,calcExpGain(b),!1)|0,!0,!1,!0)}function calcExpGain(a){return a.getNeededExp()/(100*a.getLevel())|0}function calcFluctuation(a,b,c){return 500>=a?1*b*(c?a/10|0:1):1E3>=a?.5*b*(c?a/10|0:1):1500>=a?.1*b*(c?a/10|0:1):.05*b*(c?a/10|0:1)}function calcTotal(a,b){return b*(calcFluctuation(java.lang.Math.min(a,500),1,!0)+calcFluctuation(java.lang.Math.min(a,1E3),1,!0)+calcFluctuation(java.lang.Math.min(a,1500),1,!0)+calcFluctuation(java.lang.Math.max(a-1500,0),1,!0))}function getWinningTeam(a){var b=parseInt(a.getProperty("red"));a=parseInt(a.getProperty("blue"));return b>a?0:1}function playerDead(a,b){b.getClient().getSession().write(CPacket.getPVPKilled(b.getName()+" has been defeated."));if(parseInt(a.getProperty("ice"))==b.getId())a.setProperty("ice","0"),a.setProperty("red","99999"),a.broadcastPlayerMsg(-7,"The Ice Knight has been defeated."),end(a);else{a.broadcastPlayerMsg(-7,b.getName()+" has been defeated.");if(3!=parseInt(a.getProperty("type")))if(0==b.getTeam()){var c=parseInt(a.getProperty("blue"));a.setProperty("blue",""+(c+1))}else c=parseInt(a.getProperty("red")),a.setProperty("red",""+(c+1));else c=a.getMapInstance(0),parseInt(a.getProperty("redflag"))==b.getId()?(a.setProperty("redflag","0"),a.broadcastPlayerMsg(-7,"The Red Flag has been dropped!"),c.spawnAutoDrop(291E4,b.getPosition()),a.broadcastPacket(CPacket.getCapturePosition(c)),a.broadcastPacket(CPacket.resetCapture())):parseInt(a.getProperty("blueflag"))==b.getId()&&(a.setProperty("blueflag","0"),a.broadcastPlayerMsg(-7,"The Blue Flag has been dropped!"),c.spawnAutoDrop(2910001,b.getPosition()),a.broadcastPacket(CPacket.getCapturePosition(c)),a.broadcastPacket(CPacket.resetCapture()));b.cancelAllBuffs();b.clearAllCooldowns();b.dispelDebuffs()}}function championCheck(a){for(var b=0,c=null,d=a.getPlayers(),e=0;e<d.size();e++)parseInt(a.getProperty(""+d.get(e).getId()))>b&&(b=parseInt(a.getProperty(""+d.get(e).getId())),c=d.get(e));null!=c&&(a.setProperty("champion",c.getId()+""),a.broadcastPlayerMsg(-7,c.getName()+" has been made the champion."),c.getClient().getSession().write(CPacket.showOwnChampionEffect()),c.getMap().broadcastMessage(c,CPacket.showChampionEffect(c.getId()),!1))}function updateScoreboard(a){updateScoreboard(a,!0)}function updateScoreboard(a,b){for(var c=a.getPlayers(),d=a.newPair_chr(),e=parseInt(a.getProperty("type")),g=parseInt(a.getProperty("lvl")),f=0;f<c.size();f++)a.addToPair_chr(d,parseInt(a.getProperty(""+c.get(f).getId())),c.get(f));if(1==b||null==b)a.broadcastPacket(CPacket.getPVPScoreboard(d,e)),0!=e&&2!=e&&(a.broadcastPacket(CPacket.getPVPPoints(parseInt(a.getProperty("red")),parseInt(a.getProperty("blue")))),3==e&&(3<=parseInt(a.getProperty("blue"))||3<=parseInt(a.getProperty("red")))&&end(a));else for(var k=0==e?0:getWinningTeam(a),f=0;f<c.size();f++){var l=parseInt(a.getProperty(""+c.get(f).getId())),h=calcTotal(l,calcExpGain(c.get(f))),h=h+(h*(0!=e&&c.get(f).getTeam()==k?60:30)/100|0);parseInt(a.getProperty("champion"))==c.get(f).getId()&&(h+=h/100|0);2>g&&120<=c.get(f).getLevel()&&(h/=2,l/=2);h=2*h|0;c.get(f).gainExp(h,!0,!0,!0);c.get(f).setTotalBattleExp(c.get(f).getTotalBattleExp()+(l/10|0));c.get(f).setBattlePoints(c.get(f).getBattlePoints()+(l/10|0));c.get(f).getClient().getSession().write(CPacket.getPVPResult(d,h,k+1,c.get(f).getTeam()+1))}}function playerRevive(a,b){return!0}function scheduledTimeout(a){end(a)}function changedMap(a,b,c){c!=parseInt(a.getProperty("map"))&&playerExit(a,b)}function playerDisconnected(a,b){0<a.getPlayerCount()&&!a.getProperty("started").equals("2")&&(a.getPlayerCount(),a.getProperty("started").equals("1"),1)&&end(a);b.setMap(b.getClient().getChannelServer().getMapFactory().getMap(96E7));return 0}function monsterValue(a,b){return 1}function playerExit(a,b){b.getClient().getSession().write(WvsContext.clearMidMsg());a.unregisterPlayer(b);0<a.getPlayerCount()&&!a.getProperty("started").equals("2")&&(a.getPlayerCount(),a.getProperty("started").equals("1"),1)?end(a):a.disposeIfPlayerBelow(0,0)}function end(a){a.setProperty("started","2");a.broadcastPacket(CPacket.getPVPMode(6));a.broadcastPacket(CPacket.enablePVP(!1));updateScoreboard(a,!1);for(var b=a.getPlayers(),c=0;c<b.size();c++)b.get(c).getClient().getSession().write(WvsContext.clearMidMsg()),b.get(c).cancelAllBuffs(),b.get(c).dispelDebuffs(),b.get(c).changeRemoval(),b.get(c).clearAllCooldowns(),b.get(c).getStat().heal(b.get(c));a.disposeIfPlayerBelow(100,96E7);for(c=0;c<b.size();c++)b.get(c).getStat().recalcLocalStats(b.get(c)),b.get(c).getStat().heal(b.get(c))}function clearPQ(a){end(a)}function allMonstersDead(a){}function leftParty(a,b){}function disbandParty(a){}function cancelSchedule(){};