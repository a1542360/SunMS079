importPackage(Packages.tools);var exitMap=0,waitingMap=1,reviveMap=2,fieldMap=3,winnerMap=4,loserMap=5;function init(){}function monsterValue(a,b){return 1}function setup(a){var b=parseInt(a);a=em.newInstance("cpq"+a);a.setInstanceMap(98E7);a.setInstanceMap(b);a.setInstanceMap(b+2);a.setInstanceMap(b+1).resetFully();a.setInstanceMap(b+3);a.setInstanceMap(b+4);a.setProperty("forfeit","false");a.setProperty("blue","-1");a.setProperty("red","-1");a.getMapInstance(reviveMap).getPortal("pt00").setScriptName("MCrevive1");a.setProperty("started","false");return a}function playerEntry(a,b){b.disposeClones();b.changeMap(a.getMapInstance(waitingMap),a.getMapInstance(waitingMap).getPortal(0));b.tryPartyQuest(1301)}function registerCarnivalParty(a,b){a.getProperty("red").equals("-1")?(a.setProperty("red",b.getLeader().getId()+""),a.schedule("end",18E4),a.broadcastPlayerMsg(5,"\u63a5\u4e0b\u6765\u7684\u4e09\u5206\u949f\uff0c\u60a8\u7684\u961f\u4f0d\u53ef\u4ee5\u627e\u5bfb\u5176\u4ed6\u4eba\u6311\u6218\u3002")):(a.setProperty("blue",b.getLeader().getId()+""),a.schedule("check",1E3),a.broadcastPlayerMsg(5,"\u6b63\u5728\u68c0\u6d4b\u662f\u5426\u6709\u5077\u6e21\u8005..."))}function playerDead(a,b){}function leftParty(a,b){disbandParty(a)}function disbandParty(a){disposeAll(a)}function disposeAll(a){for(var b=a.getPlayers().iterator();b.hasNext();){var c=b.next();a.unregisterPlayer(c);c.changeMap(a.getMapInstance(exitMap),a.getMapInstance(exitMap).getPortal(0));c.getCarnivalParty().removeMember(c)}a.dispose()}function playerExit(a,b){a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);b.changeMap(a.getMapInstance(exitMap),a.getMapInstance(exitMap).getPortal(0));a.disposeIfPlayerBelow(0,0)}function removePlayer(a,b){a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);b.getMap().removePlayer(b);b.setMap(a.getMapInstance(exitMap));a.disposeIfPlayerBelow(0,0)}function getParty(a,b){var c=em.getChannelServer().getPlayerStorage().getCharacterById(parseInt(a.getProperty(b)));return null==c?(a.broadcastPlayerMsg(5,"\u961f\u4f0d\u7684\u961f\u957f "+b+" \u627e\u4e0d\u5230\u3002"),disposeAll(a),null):c.getCarnivalParty()}function start(a){a.setProperty("started","true");a.startEventTimer(6E5);var b=getParty(a,"blue");null!=b&&b.warp(a.getMapInstance(fieldMap),"blue00");b=getParty(a,"red");null!=b&&b.warp(a.getMapInstance(fieldMap),"red00")}function check(a){a.check()?(a.broadcastPlayerMsg(5,"\u68c0\u6d4b.\u76ee\u524d\u65e0\u5f02\u5e38....!"),a.schedule("start",1E4),a.broadcastPlayerMsg(5,"10\u79d2\u540e\u5c06\u5f00\u6218\uff01\uff01")):(a.broadcastPlayerMsg(5,"\u68c0\u6d4b..\u53d1\u73b0\u5f02\u5e38!! \u5373\u5c06\u4f20\u9001\u56de\u53bb"),disposeAll(a))}function monsterKilled(a,b,c){b.getCarnivalParty().addCP(b,c);b.CPUpdate(!1,b.getAvailableCP(),b.getTotalCP(),0);for(a=a.getPlayers().iterator();a.hasNext();)a.next().CPUpdate(!0,b.getCarnivalParty().getAvailableCP(),b.getCarnivalParty().getTotalCP(),b.getCarnivalParty().getTeam())}function monsterValue(a,b){return 0}function end(a){a.getProperty("started").equals("true")||disposeAll(a)}function warpOut(a){if(a.getProperty("started").equals("true")){var b=getParty(a,"blue"),c=getParty(a,"red");b.isWinner()?(b.warp(a.getMapInstance(winnerMap),0),c.warp(a.getMapInstance(loserMap),0)):(c.warp(a.getMapInstance(winnerMap),0),b.warp(a.getMapInstance(loserMap),0));a.disposeIfPlayerBelow(100,0)}else a.getProperty("blue").equals("-1")&&disposeAll(a)}function scheduledTimeout(a){a.stopEventTimer();if(a.getProperty("started").equals("true")){var b=getParty(a,"blue"),c=getParty(a,"red");null!=b&&null!=c&&(b.getTotalCP()>c.getTotalCP()?b.setWinner(!0):c.getTotalCP()>b.getTotalCP()&&c.setWinner(!0),b.displayMatchResult(),c.displayMatchResult());a.schedule("warpOut",1E4)}else a.getProperty("blue").equals("-1")&&disposeAll(a)}function playerRevive(a,b){b.getCarnivalParty().useCP(b,10);for(var c=a.getPlayers().iterator();c.hasNext();)c.next().CPUpdate(!0,b.getCarnivalParty().getAvailableCP(),b.getCarnivalParty().getTotalCP(),b.getCarnivalParty().getTeam());b.addHP(50);b.changeMap(a.getMapInstance(reviveMap),a.getMapInstance(reviveMap).getPortal(0));return!0}function playerDisconnected(a,b){b.setMap(a.getMapInstance(exitMap));a.unregisterPlayer(b);b.getCarnivalParty().removeMember(b);a.broadcastPlayerMsg(5,b.getName()+" \u79bb\u5f00\u4e86\u5609\u5e74\u534e1");disposeAll(a);a.forceRemovePlayerByCharName(b.getName())}function onMapLoad(a,b){if(a.getProperty("started").equals("true")){var c=0==b.getCarnivalParty().getTeam()?getParty(a,"blue"):getParty(a,"red");b.startMonsterCarnival(c.getAvailableCP(),c.getTotalCP())}else disposeAll(a)}function cancelSchedule(){}function clearPQ(a){}function allMonstersDead(a){}function changedMap(a,b,c){};